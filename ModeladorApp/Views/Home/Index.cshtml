@model IEnumerable<ModeladorApp.Models.Entities.TB_PERMISOS>

@{
    ViewData["Title"] = "Inicio";
}
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>

<style>
    .loadingP {
        background-image: url(img/loading.gif);
        width: 15px;
        display: inline-block;
    }

    .colapsado {
        width: 15px;
        cursor: pointer;
    }

    .expandido {
        width: 15px;
        background-image: url(https://image.pngaaa.com/549/4811549-middle.png);
        background-repeat: no-repeat;
        background-position: -50px -17px;
        display: inline-block;
        cursor: pointer;
    }

    .treeview ul {
        font: 14px Arial, Sans-Serif;
        margin: 0px;
        padding-left: 20px;
        list-style: none;
    }

    .treeview > li > a {
        font-weight: bold;
    }

    .treeview li a {
        padding: 4px;
        font-size: 12px;
        display: inline-block;
        text-decoration: none;
        width: auto;
    }
</style>


<script type="text/javascript">

    window.onload = loadMaster();

    async function loadMaster() {

        //removemos el pane del proyecto master para volverlo a construir
        $("#masterPane").remove();

        //muestra el loader cuando volvemos a hacer click aqui
        $("#emptyPy").show();

        var data = await funGetMasterData()

        //cuando termina de ejecutarse la función asyncrona oculta el loader...
        $("#emptyPy").hide();

        //------------------------------------------------------------->>>Treeview Master
        var treeview = "";

        treeview = treeview + '<br />';
        treeview = treeview + '<div id="masterPane" style="border:1px solid black; padding:0px; background-color:#FAFAFA">';
        treeview = treeview + '<div class="treeview">';

        treeview = treeview + '<ul>';

        treeview = treeview + '<li>';
        treeview = treeview + '<span class="colapsado avatar avatar-xs rounded me-2" style="background-image: url(https://image.pngaaa.com/73/4388073-middle.png)" id="node_' + data[0].nivelID + '" onclick="getSubMenus(' + data[0].nivelID + ')" data-loaded="false" pid="">&nbsp;</span>';
        treeview = treeview + '<span><a style="cursor:pointer">' + data[0].identificador + '</a></span> - ';
        treeview = treeview + '<span><a style="cursor:pointer" onclick="editNombre(' + data[0].nivelID + ')">' + data[0].nombre + '</a></span>';
        treeview = treeview + '</li>';

        treeview = treeview + '</ul>';
        treeview = treeview + '</div>';
        treeview = treeview + '</div>';

        $('#master').append(treeview).fadeIn(300000);
        //------------------------------------------------------------->>>Treeview Master
    }

    //trae la información del Master.
    function funGetMasterData() {
        var url = "/Home/FunGetMaster";
        return $.get(url, {}, function (data) {
            //console.log(data);
        });
    };


    function getSubMenus(pId) {

        console.log(pId)

        //Comprobar si la data se ha cargado
        if ($('#node_' + pId).attr('data-loaded') === 'false') {

            $('#node_' + pId).addClass("loadingP");   // Show loading panel
            $('#node_' + pId).removeClass("colapsado");

            console.log("ENTRO");
            // Now Load Data Here
            $.ajax({
                url: "/Home/funGetSubNiveles",
                type: "GET",
                data: { parentId: pId },
                dataType: "json",
                success: function (d) {

                    console.log(d);

                    $('#node_' + pId).removeClass("loadingP");

                    if (d.length > 0) {

                        var $ul = $("<ul></ul>");
                        $.each(d, function (i, element) {
                            $ul.append(
                                $("<li></li>").append(
                                    '<span class="colapsado avatar avatar-xs rounded me-2" style="background-image: url(https://image.pngaaa.com/73/4388073-middle.png)" id="node_' + element.nivelID + '" onclick="getSubMenus(' + element.nivelID + ')" data-loaded="false" pid="' + element.nivelID + '">&nbsp;</span>' +
                                    '<span><a onclick="editIdentificador(' + element.nivelID + ')">' + element.identificador + '</a></span>' + '-' +
                                    '<span><a onclick="editNombre(' + element.nivelID + ')">' + element.nombre + '</a></span>'
                                )
                            )
                        });

                        $('#node_' + pId).parent().append($ul);
                        $('#node_' + pId).addClass('colapsado');
                        $('#node_' + pId).toggleClass('colapsado expandido');
                        $('#node_' + pId).closest('li').children('ul').slideDown();
                    }
                    else {
                        // no sub menu
                        $('#node_' + pId).css({ 'display': 'inline-block', 'width': '15px' });
                    }

                    $('#node_' + pId).attr('data-loaded', true);
                },
                error: function () {
                    alert("Error!");
                }
            });
        }
        else {
            // if already data loaded
            $('#node_' + pId).toggleClass("colapsado expandido");
            $('#node_' + pId).closest('li').children('ul').slideToggle();
        }
    }




    function editNombre(vId) {

        console.log(vId)

    }

    function editIdentificador(vId) {

        console.log(vId)

    }

</script>


<form asp-action="Index" method="get">



    <div class="page-body">
        <div class="container-fluid">

            <div class="row row-deck row-cards">

                <div class="col-lg-12">
                    <div class="row row-cards">

                        <div class="col-md-12">
                            <div class="card">

                                <ul class="nav nav-tabs nav-fill" data-bs-toggle="tabs">
                                    <li class="nav-item">
                                        <a href="#master" onclick="loadMaster()" class="nav-link active"
                                           data-bs-toggle="tab"><strong>MASTER</strong></a>
                                    </li>
                                    @foreach (var item in Model)
                                    {
                                        <li class="nav-item">
                                            <a href="#proyecto_@item.ProyectoID" class="nav-link"
                                               data-bs-toggle="tab">@Html.DisplayFor(modelItem => item.TB_PROYECTO.NombreProyecto)</a>
                                        </li>
                                    }
                                </ul>

                                <div class="card-body">

                                    <div class="tab-content">                                       

                                        <div class="tab-pane show active" id="master">

                                            

                                            <div class="row align-items-center">
                                                <div class="col-auto ms-auto d-print-none">
                                                    <div class="btn-list">

                                                        <span class="d-none d-sm-inline">
                                                            <a href="#" class="btn btn-primary">
                                                                Clonar
                                                            </a>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="empty" id="emptyPy">
                                                <div class="empty-img">
                                                    <img src="https://miro.medium.com/max/875/1*CsJ05WEGfunYMLGfsT2sXA.gif" height="128">
                                                </div>
                                                <p class="empty-title">Cargando "MASTER"</p>
                                            </div>

                                        </div>


                                        @foreach (var item in Model)
                                        {
                                            <div class="tab-pane" id="proyecto_@item.ProyectoID">

                                                @if (item.Permiso == "EDITOR")
                                                {
                                                    <div class="row align-items-center">
                                                        <div class="col-auto ms-auto d-print-none">
                                                            <div class="btn-list">

                                                                <span class="d-none d-sm-inline">
                                                                    <a href="#" class="btn btn-primary">
                                                                        Editar
                                                                    </a>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }

                                                <div class="empty" id="emptyPy_@item.TB_PROYECTO.NombreProyecto">
                                                    <div class="empty-img">
                                                        <img src="https://miro.medium.com/max/875/1*CsJ05WEGfunYMLGfsT2sXA.gif" height="128">
                                                    </div>
                                                    <p class="empty-title">Cargando "@item.TB_PROYECTO.NombreProyecto"</p>
                                                </div>

                                            </div>
                                        }

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</form>
